<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gree Runner</title>
    <style>
        :root {
            --bg-top: #0f172a;
            --bg-bottom: #020617;
            --accent: #22c55e;
            --accent-soft: #4ade80;
            --accent-strong: #16a34a;
            --text-soft: #9ca3af;
            --text-main: #e5e7eb;
            --card-border: #1f2937;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at top, #1f2937 0%, #020617 60%);
            color: var(--text-main);
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        }

        .shell {
            width: 90vw;
            max-width: 780px;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .logo {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .logo-main {
            font-weight: 700;
            font-size: 20px;
            letter-spacing: 0.05em;
        }

        .logo-pill {
            font-size: 11px;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            color: var(--text-soft);
        }

        .scores {
            font-size: 13px;
            text-align: right;
        }

        .scores span.value {
            font-weight: 600;
            color: var(--accent-soft);
        }

        .scores .label {
            color: var(--text-soft);
        }

        .game {
            position: relative;
            width: 660px;
            max-width: 100%;
            height: 230px;
            margin: 0 auto;
            border-radius: 16px;
            border: 1px solid var(--card-border);
            background: linear-gradient(to top, var(--bg-bottom) 0%, var(--bg-top) 60%);
            overflow: hidden;
            box-shadow:
                0 20px 45px rgba(0, 0, 0, 0.85),
                0 0 0 1px rgba(148, 163, 184, 0.06);
        }

        .sky-glow {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 15% 0%, rgba(148, 163, 184, 0.35), transparent 55%);
            pointer-events: none;
            mix-blend-mode: screen;
        }

        .cloud {
            position: absolute;
            top: 24px;
            width: 90px;
            height: 28px;
            background: rgba(148, 163, 184, 0.22);
            border-radius: 999px;
            filter: blur(0.4px);
        }

        .cloud::before,
        .cloud::after {
            content: "";
            position: absolute;
            background: inherit;
            border-radius: inherit;
        }

        .cloud::before {
            width: 52px;
            height: 22px;
            left: 8px;
            top: -11px;
        }

        .cloud::after {
            width: 44px;
            height: 20px;
            right: 10px;
            top: -9px;
        }

        .cloud-1 { left: 20%; opacity: 0.9; }
        .cloud-2 { left: 65%; top: 40px; opacity: 0.7; transform: scale(0.9); }

        .ground {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 140%;
            height: 36px;
            background:
                linear-gradient(to top, #020617 0%, #020617 10px, transparent 10px),
                repeating-linear-gradient(
                    -45deg,
                    #374151 0,
                    #374151 12px,
                    #111827 12px,
                    #111827 24px
                );
            animation: groundScroll 0.6s linear infinite;
        }

        @keyframes groundScroll {
            from { transform: translateX(0); }
            to   { transform: translateX(-32px); }
        }

        /* Square player (runner) */
        .runner {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(to bottom, #4ade80, #22c55e, #15803d);
            box-shadow:
                0 0 0 2px rgba(15, 23, 42, 0.9),
                0 10px 20px rgba(0, 0, 0, 0.9);
            transform-origin: center center;
        }

        .runner::after {
            content: "";
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.85);
            top: 9px;
            left: 10px;
        }

        .runner.spin {
            animation: runnerSpin 0.35s ease-out;
        }

        @keyframes runnerSpin {
            0%   { transform: translateY(0) rotate(0deg); }
            50%  { transform: translateY(-6px) rotate(360deg); }
            100% { transform: translateY(0) rotate(720deg); }
        }

        .dust {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: rgba(148,163,184,0.35);
            bottom: 36px;
            opacity: 0;
            pointer-events: none;
        }

        .dust.show {
            animation: dustPop 0.25s ease-out;
        }

        @keyframes dustPop {
            0%   { transform: translateX(0) translateY(0) scale(1); opacity: 0.6; }
            100% { transform: translateX(-10px) translateY(-6px) scale(0.2); opacity: 0; }
        }

        .obstacle {
            position: absolute;
            bottom: 36px;
            width: 26px;
            height: 58px;
            background: linear-gradient(to bottom, #facc15, #eab308, #a16207);
            border-radius: 8px 8px 4px 4px;
            box-shadow: 0 10px 18px rgba(0, 0, 0, 0.9);
        }

        .obstacle.tall {
            background: linear-gradient(to bottom, #f97316, #ea580c, #9a3412);
        }

        .obstacle.fat {
            background: linear-gradient(to bottom, #38bdf8, #0ea5e9, #0369a1);
        }

        .obstacle.short {
            background: linear-gradient(to bottom, #a855f7, #7c3aed, #5b21b6);
        }

        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .overlay-inner {
            pointer-events: auto;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
            border-radius: 16px;
            padding: 16px 18px;
            max-width: 80%;
            text-align: center;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.95);
        }

        .overlay.hidden {
            display: none;
        }

        .overlay-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .overlay-sub {
            font-size: 13px;
            color: var(--text-soft);
            margin-bottom: 10px;
        }

        .overlay-btn {
            margin-top: 4px;
            border: none;
            outline: none;
            padding: 7px 16px;
            border-radius: 999px;
            background: linear-gradient(135deg, var(--accent-soft), var(--accent-strong));
            color: #01210e;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow:
                0 10px 18px rgba(0, 0, 0, 0.85),
                0 0 0 1px rgba(22, 163, 74, 0.5);
        }

        .overlay-btn:active {
            transform: translateY(1px);
            box-shadow:
                0 6px 12px rgba(0, 0, 0, 0.9),
                0 0 0 1px rgba(22, 163, 74, 0.5);
        }

        .footer {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            font-size: 12px;
            color: var(--text-soft);
            flex-wrap: wrap;
        }

        .key-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.8);
        }

        .key {
            min-width: 18px;
            padding: 1px 4px;
            border-radius: 4px;
            border: 1px solid rgba(148, 163, 184, 0.65);
            font-size: 10px;
            text-align: center;
        }

        .hint {
            opacity: 0.9;
        }

        .theme-row {
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-soft);
            flex-wrap: wrap;
            gap: 6px;
        }

        .theme-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .theme-btn {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text-soft);
            padding: 2px 10px;
            font-size: 11px;
            cursor: pointer;
        }

        .theme-btn.active {
            border-color: var(--accent-soft);
            color: var(--accent-soft);
            background: rgba(22, 163, 74, 0.12);
        }

        .sound-state {
            font-size: 12px;
        }

        .milestone {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            padding: 3px 9px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(74, 222, 128, 0.6);
            color: #bbf7d0;
            opacity: 0;
            pointer-events: none;
        }

        .milestone.show {
            animation: milestonePop 0.7s ease-out;
        }

        @keyframes milestonePop {
            0%   { transform: translateX(-50%) translateY(0) scale(0.9); opacity: 0; }
            20%  { transform: translateX(-50%) translateY(0) scale(1);   opacity: 1; }
            80%  { transform: translateX(-50%) translateY(-6px) scale(1); opacity: 1; }
            100% { transform: translateX(-50%) translateY(-10px) scale(0.95); opacity: 0; }
        }

        @media (max-width: 540px) {
            .logo-main { font-size: 18px; }
            .overlay-inner {
                max-width: 92%;
                padding: 14px 14px;
            }
            .footer {
                flex-direction: column;
                align-items: flex-start;
            }
            .theme-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
<div class="shell">
    <header class="hud">
        <div class="logo">
            <span class="logo-main">Gree Runner</span>
            <span class="logo-pill">Endless 2D Runner</span>
        </div>
        <div class="scores">
            <div>
                <span class="label">Score:</span>
                <span id="score" class="value">0</span>
                &nbsp;|&nbsp;
                <span class="label">Best:</span>
                <span id="bestScore" class="value">0</span>
            </div>
            <div>
                <span class="label">Perfect streak:</span>
                <span id="streak" class="value">0</span>
            </div>
        </div>
    </header>

    <main class="game" id="gameArea" tabindex="0">
        <div class="sky-glow"></div>
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>

        <div class="ground" id="ground"></div>
        <div class="runner" id="runner"></div>
        <div class="obstacle" id="obstacle"></div>
        <div class="dust" id="dust"></div>
        <div class="milestone" id="milestone"></div>

        <div class="overlay" id="overlay">
            <div class="overlay-inner">
                <div class="overlay-title" id="overlayTitle">Gree Runner</div>
                <div class="overlay-sub" id="overlaySub">
                    Use <b>Space</b> or <b>Arrow Up</b> to jump.<br/>
                    Avoid obstacles, build streaks and chase a new high score.<br/>
                    Press <b>P</b> to pause, <b>M</b> to toggle sound.
                </div>
                <button class="overlay-btn" id="playButton">Start Game</button>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="hint">
            <span class="key-pill">
                <span class="key">Space</span>
                <span class="key">↑</span>
                <span>Jump (single)</span>
            </span>
        </div>
        <div class="hint">
            <span class="key-pill">
                <span class="key">Enter</span>
                <span>Restart</span>
            </span>
            &nbsp;
            <span class="key-pill">
                <span class="key">P</span>
                <span>Pause / Resume</span>
            </span>
            &nbsp;
            <span class="key-pill">
                <span class="key">M</span>
                <span>Sound On/Off</span>
            </span>
        </div>
    </footer>

    <div class="theme-row">
        <div>Theme: (auto rotates • press <b>T</b> to cycle)</div>
        <div class="theme-buttons">
            <button class="theme-btn" data-theme="midnight">Midnight</button>
            <button class="theme-btn" data-theme="desert">Desert</button>
            <button class="theme-btn" data-theme="classic">Classic</button>
        </div>
        <div class="sound-state">
            Sound: <span id="soundLabel">On</span>
        </div>
    </div>
</div>

<script>
    // === DOM references ===
    const gameArea = document.getElementById('gameArea');
    const runnerEl = document.getElementById('runner');
    const obstacleEl = document.getElementById('obstacle');
    const scoreEl = document.getElementById('score');
    const bestScoreEl = document.getElementById('bestScore');
    const streakEl = document.getElementById('streak');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlaySub = document.getElementById('overlaySub');
    const playButton = document.getElementById('playButton');
    const themeButtons = document.querySelectorAll('.theme-btn');
    const soundLabel = document.getElementById('soundLabel');
    const groundEl = document.getElementById('ground');
    const dustEl = document.getElementById('dust');
    const milestoneEl = document.getElementById('milestone');

    // === Themes ===
    const THEMES = {
        midnight: {
            '--bg-top': '#0f172a',
            '--bg-bottom': '#020617',
            '--accent': '#22c55e',
            '--accent-soft': '#4ade80',
            '--accent-strong': '#16a34a',
            '--text-soft': '#9ca3af',
            '--text-main': '#e5e7eb',
            '--card-border': '#1f2937'
        },
        desert: {
            '--bg-top': '#78350f',
            '--bg-bottom': '#451a03',
            '--accent': '#facc15',
            '--accent-soft': '#fde68a',
            '--accent-strong': '#eab308',
            '--text-soft': '#fed7aa',
            '--text-main': '#fffbeb',
            '--card-border': '#7c2d12'
        },
        classic: {
            '--bg-top': '#374151',
            '--bg-bottom': '#111827',
            '--accent': '#e5e7eb',
            '--accent-soft': '#f9fafb',
            '--accent-strong': '#d1d5db',
            '--text-soft': '#9ca3af',
            '--text-main': '#e5e7eb',
            '--card-border': '#4b5563'
        }
    };

    let currentTheme = 'midnight';
    let autoThemeInterval = null;

    function applyTheme(name) {
        const theme = THEMES[name] || THEMES.midnight;
        currentTheme = name;

        Object.entries(theme).forEach(([key, value]) => {
            document.documentElement.style.setProperty(key, value);
        });

        themeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === name);
        });

        try {
            localStorage.setItem('gree_runner_theme', name);
        } catch (e) {}
    }

    function cycleTheme() {
        const names = Object.keys(THEMES);
        const index = names.indexOf(currentTheme);
        const next = names[(index + 1) % names.length];
        applyTheme(next);
    }

    function startAutoThemeCycle() {
        if (autoThemeInterval) clearInterval(autoThemeInterval);
        // every 30s change background automatically
        autoThemeInterval = setInterval(() => {
            cycleTheme();
        }, 30000);
    }

    // === Sound Manager (Web Audio) + Background Music ===
    let audioCtx = null;
    let soundOn = true;
    let bgInterval = null;
    let bgStep = 0;

    function initAudio() {
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                soundOn = false;
            }
        }
    }

    function updateSoundLabel() {
        soundLabel.textContent = soundOn ? 'On' : 'Off';
        try {
            localStorage.setItem('gree_runner_sound', soundOn ? '1' : '0');
        } catch (e) {}
    }

    function playBeep(freq = 440, duration = 120, volume = 0.25, type = 'square') {
        if (!soundOn) return;
        if (!audioCtx) initAudio();
        if (!audioCtx) return;

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime + duration / 1000);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + duration / 1000);
    }

    function playJumpSound() {
        playBeep(720, 80, 0.18, 'square');
    }

    function playPerfectSound() {
        playBeep(520, 90, 0.18, 'triangle');
        setTimeout(() => playBeep(820, 90, 0.14, 'triangle'), 80);
    }

    function playGameOverSound() {
        playBeep(260, 220, 0.22, 'sawtooth');
    }

    function playPauseSound() {
        playBeep(420, 80, 0.16, 'square');
    }

    const bgPattern = [330, 392, 440, 0, 330, 392, 523, 0];

    function startBackgroundMusic() {
        if (!soundOn) return;
        if (!audioCtx) initAudio();
        if (!audioCtx) return;
        if (bgInterval) return;

        bgInterval = setInterval(() => {
            if (!soundOn || !audioCtx) return;
            const freq = bgPattern[bgStep % bgPattern.length];
            bgStep++;
            if (!freq) return;
            playBeep(freq, 200, 0.06, 'sine');
        }, 260);
    }

    function stopBackgroundMusic() {
        if (bgInterval) {
            clearInterval(bgInterval);
            bgInterval = null;
        }
    }

    // === Game constants ===
    const GAME_HEIGHT = 230;
    const GROUND_HEIGHT = 36;
    const GROUND_Y = GROUND_HEIGHT;

    const RUNNER_SIZE = 40;
    const RUNNER_X = 80;

    const GRAVITY = 1200;
    const JUMP_VELOCITY = 520;
    const MAX_JUMPS = 1;   // SINGLE JUMP ONLY

    const BASE_SPEED = 260;
    const MAX_EXTRA_SPEED = 220;          // max extra speed
    const SCORE_TICK = 0.1;               // 1 score per 0.1s => ~10 per second
    const PERFECT_MIN_HEIGHT = 24;

    const OBSTACLE_TYPES = [
        { w: 26, h: 58, className: "" },
        { w: 22, h: 46, className: "short" },
        { w: 30, h: 52, className: "fat" },
        { w: 24, h: 72, className: "tall" }
    ];

    // === Game state ===
    let gameWidth = 660;
    let lastTimestamp = null;
    let state = 'menu'; // 'menu' | 'playing' | 'paused' | 'gameover'

    let score = 0;
    let scoreTimer = 0;    // Chrome-style ticking
    let bestScore = 0;
    let perfectStreak = 0;

    let runnerY = GROUND_Y;
    let runnerVy = 0;
    let jumpCount = 0;
    let wasOnGround = true; // for dust

    let obstacleX = 0;
    let obstacleWidth = 26;
    let obstacleHeight = 58;
    let obstaclePassed = false;

    let speed = BASE_SPEED;

    // === Load saved settings ===
    (function loadSettings() {
        try {
            const storedTheme = localStorage.getItem('gree_runner_theme');
            if (storedTheme && THEMES[storedTheme]) {
                currentTheme = storedTheme;
            }
        } catch (e) {}
        applyTheme(currentTheme);

        try {
            const soundPref = localStorage.getItem('gree_runner_sound');
            if (soundPref === '0') soundOn = false;
        } catch (e) {}
        updateSoundLabel();

        try {
            const storedBest = localStorage.getItem('gree_runner_pro_best');
            if (storedBest) {
                bestScore = parseInt(storedBest, 10) || 0;
                bestScoreEl.textContent = bestScore;
            }
        } catch (e) {}
    })();

    // === Overlay helper ===
    function setOverlay(title, subHtml, buttonLabel) {
        overlayTitle.textContent = title;
        overlaySub.innerHTML = subHtml;
        playButton.textContent = buttonLabel;
    }

    // === Init positions ===
    function initPositions() {
        gameWidth = gameArea.clientWidth || 660;
        runnerY = GROUND_Y;
        runnerVy = 0;
        jumpCount = 0;

        runnerEl.style.left = RUNNER_X + 'px';
        runnerEl.style.bottom = runnerY + 'px';

        spawnNewObstacle(true);
        updateDOM();
    }

    // === Spawn obstacle with time-based spacing (fair at any speed) ===
    function spawnNewObstacle(initial = false) {
        const type = OBSTACLE_TYPES[Math.floor(Math.random() * OBSTACLE_TYPES.length)];
        obstacleWidth = type.w;
        obstacleHeight = type.h;

        obstacleEl.className = 'obstacle ' + (type.className || '');
        obstacleEl.style.width = obstacleWidth + 'px';
        obstacleEl.style.height = obstacleHeight + 'px';
        obstacleEl.style.bottom = GROUND_Y + 'px';

        // gap based on time, not pixels: 1.2–2s at current speed
        const minTime = initial ? 1.6 : 1.2;
        const maxTime = initial ? 2.2 : 2.0;
        const gapTime = minTime + Math.random() * (maxTime - minTime);
        const offset = speed * gapTime;

        obstacleX = gameWidth + offset;
        obstaclePassed = false;
    }

    // === Reset run ===
    function resetRun() {
        score = 0;
        scoreTimer = 0;
        perfectStreak = 0;
        scoreEl.textContent = '0';
        streakEl.textContent = '0';

        speed = BASE_SPEED;

        runnerY = GROUND_Y;
        runnerVy = 0;
        jumpCount = 0;
        wasOnGround = true;

        spawnNewObstacle(true);
        updateDOM();
    }

    // === Start game ===
    function startGame() {
        state = 'playing';
        overlay.classList.add('hidden');
        resetRun();
        startBackgroundMusic();
    }

    // === Pause / resume ===
    function togglePause() {
        if (state === 'playing') {
            state = 'paused';
            setOverlay(
                'Paused',
                'Game is paused.<br/>Press <b>P</b> or click below to resume.',
                'Resume'
            );
            overlay.classList.remove('hidden');
            stopBackgroundMusic();
            playPauseSound();
        } else if (state === 'paused') {
            state = 'playing';
            overlay.classList.add('hidden');
            startBackgroundMusic();
            playPauseSound();
        }
    }

    // === End game ===
    function endGame() {
        state = 'gameover';
        const finalScore = Math.floor(score);

        if (finalScore > bestScore) {
            bestScore = finalScore;
            bestScoreEl.textContent = bestScore;
            try {
                localStorage.setItem('gree_runner_pro_best', bestScore);
            } catch (e) {}
        }

        setOverlay(
            'Game Over',
            `Score: <b>${finalScore}</b> &nbsp;|&nbsp; Best: <b>${bestScore}</b><br/>
             Best streak: <b>${perfectStreak}</b><br/>
             Press <b>Enter</b> or click below to run again.`,
            'Play Again'
        );
        overlay.classList.remove('hidden');
        stopBackgroundMusic();
        playGameOverSound();
    }

    // === Dust effect on landing ===
    function triggerDust() {
        dustEl.classList.remove('show');
        // force reflow
        void dustEl.offsetWidth;
        dustEl.style.left = (RUNNER_X + RUNNER_SIZE * 0.3) + 'px';
        dustEl.classList.add('show');
    }

    // === Milestone text (for 100, 200, 500, etc) ===
    const milestonesShown = new Set();
    function checkMilestones(intScore) {
        const important = [100, 200, 500, 800, 1200];
        for (const m of important) {
            if (intScore >= m && !milestonesShown.has(m)) {
                milestonesShown.add(m);
                showMilestone(m);
            }
        }
    }

    function showMilestone(m) {
        let text = '';
        if (m === 100) text = 'Nice warm up!';
        else if (m === 200) text = 'Getting in the flow!';
        else if (m === 500) text = 'You are on fire!';
        else if (m === 800) text = 'Unstoppable!';
        else text = 'Legend!';

        milestoneEl.textContent = text;
        milestoneEl.classList.remove('show');
        void milestoneEl.offsetWidth;
        milestoneEl.classList.add('show');
    }

    // === Jump (single jump only) ===
    function jump() {
        if (state === 'menu') {
            startGame();
        } else if (state === 'gameover') {
            startGame();
        } else if (state === 'paused') {
            return;
        }

        if (state !== 'playing') return;

        if (jumpCount < MAX_JUMPS) {
            runnerVy = JUMP_VELOCITY;
            jumpCount++;
            runnerEl.classList.remove('spin');
            void runnerEl.offsetWidth;
            runnerEl.classList.add('spin');
            playJumpSound();
        }
    }

    // === Collision detection ===
    function hasCollision() {
        const runnerLeft = RUNNER_X;
        const runnerRight = RUNNER_X + RUNNER_SIZE;
        const runnerBottom = runnerY;
        const runnerTop = runnerY + RUNNER_SIZE;

        const obstacleLeft = obstacleX;
        const obstacleRight = obstacleX + obstacleWidth;
        const obstacleBottom = GROUND_Y;
        const obstacleTop = GROUND_Y + obstacleHeight;

        const overlapX = runnerRight > obstacleLeft + 4 && runnerLeft < obstacleRight - 4;
        const overlapY = runnerTop > obstacleBottom + 4 && runnerBottom < obstacleTop - 4;

        return overlapX && overlapY;
    }

    // === Perfect pass detection ===
    function checkPerfectPass() {
        const runnerHeightAboveGround = runnerY - GROUND_Y;

        if (runnerHeightAboveGround > PERFECT_MIN_HEIGHT) {
            perfectStreak++;
            score += 10 * perfectStreak;
            playPerfectSound();
        } else {
            perfectStreak = 0;
        }
        streakEl.textContent = perfectStreak;
    }

    // === Update DOM ===
    function updateDOM() {
        runnerEl.style.bottom = runnerY + 'px';
        obstacleEl.style.left = obstacleX + 'px';
    }

    // === Main loop ===
    function loop(timestamp) {
        if (lastTimestamp === null) {
            lastTimestamp = timestamp;
        }
        const dt = (timestamp - lastTimestamp) / 1000;
        lastTimestamp = timestamp;

        if (state === 'playing') {
            // physics
            runnerVy -= GRAVITY * dt;
            runnerY += runnerVy * dt;

            const onGround = runnerY <= GROUND_Y;

            if (onGround) {
                if (!wasOnGround) {
                    triggerDust();
                }
                runnerY = GROUND_Y;
                runnerVy = 0;
                jumpCount = 0;
            }
            wasOnGround = onGround;

            const distanceStep = speed * dt;
            obstacleX -= distanceStep;

            if (!obstaclePassed && obstacleX + obstacleWidth < RUNNER_X) {
                obstaclePassed = true;
                checkPerfectPass();
            }

            if (obstacleX + obstacleWidth < -40) {
                spawnNewObstacle(false);
            }

            // Chrome-style scoring: ~10 points per second
            scoreTimer += dt;
            while (scoreTimer >= SCORE_TICK) {
                score += 1;
                scoreTimer -= SCORE_TICK;
            }
            const intScore = Math.floor(score);
            scoreEl.textContent = intScore;
            checkMilestones(intScore);

            // Speed smoothly increases with score
            const extraSpeed = Math.min((intScore / 100) * 18, MAX_EXTRA_SPEED);
            speed = BASE_SPEED + extraSpeed;

            // Ground animation sync with speed
            const baseDuration = 0.6;
            const factor = BASE_SPEED / speed;
            groundEl.style.animationDuration = (baseDuration * factor).toFixed(3) + 's';

            if (hasCollision()) {
                endGame();
            }
        } else if (state === 'paused' || state === 'menu' || state === 'gameover') {
            lastTimestamp = timestamp;
        }

        updateDOM();
        requestAnimationFrame(loop);
    }

    // === Input handling ===
    document.addEventListener('keydown', (event) => {
        if (event.code === 'Space' || event.code === 'ArrowUp') {
            event.preventDefault();
            jump();
        } else if (event.code === 'Enter') {
            if (state === 'gameover' || state === 'menu') {
                startGame();
            }
        } else if (event.code === 'KeyP') {
            if (state === 'playing' || state === 'paused') {
                togglePause();
            }
        } else if (event.code === 'KeyM') {
            soundOn = !soundOn;
            if (soundOn) {
                initAudio();
                if (state === 'playing') startBackgroundMusic();
            } else {
                stopBackgroundMusic();
            }
            updateSoundLabel();
        } else if (event.code === 'KeyT') {
            cycleTheme();
        }
    });

    gameArea.addEventListener('click', () => {
        jump();
        gameArea.focus();
    });

    gameArea.addEventListener('touchstart', (event) => {
        event.preventDefault();
        jump();
        gameArea.focus();
    }, { passive: false });

    playButton.addEventListener('click', () => {
        if (state === 'paused') {
            togglePause();
        } else {
            startGame();
        }
        gameArea.focus();
    });

    themeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            applyTheme(btn.dataset.theme);
            // manual theme change bhi allowed, auto cycle chalti rahegi
        });
    });

    // === Resize handling ===
    window.addEventListener('resize', () => {
        gameWidth = gameArea.clientWidth || 660;
        if (obstacleX > gameWidth + 200) {
            obstacleX = gameWidth + 120;
        }
    });

    // === Initial setup ===
    (function init() {
        // start in menu
        state = 'menu';
        setOverlay(
            'Gree Runner',
            'Use <b>Space</b> or <b>Arrow Up</b> to jump.<br/>' +
            'Avoid colorful obstacles and build your perfect streak.<br/>' +
            'Press <b>P</b> to pause, <b>M</b> to toggle sound, <b>T</b> to switch theme.',
            'Start Game'
        );
        overlay.classList.remove('hidden');
        initPositions();

        // ensure theme + auto changer
        applyTheme(currentTheme);
        startAutoThemeCycle();

        requestAnimationFrame(loop);
    })();
</script>
</body>
</html>
